<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´ì¹´ì˜¤ T ê³ ê°ì„¼í„° ì§ë¬´í…ŒìŠ¤íŠ¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #1a2332;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .header {
      background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
      position: relative;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 900;
      color: #ffb800;
      letter-spacing: 2px;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .header .subtitle {
      font-size: 16px;
      opacity: 0.9;
      font-weight: 300;
    }
    
    .timer-box {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ffb800;
      color: #1a2332;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 184, 0, 0.4);
      display: none;
    }
    
    .timer-box.active {
      display: block;
    }
    
    .timer-box.warning {
      background: #ff4757;
      color: white;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .content {
      padding: 40px;
    }
    
    /* ë¡œê·¸ì¸ í™”ë©´ */
    .info-card {
      background: #fffbf0;
      border: 2px solid #ffb800;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .info-card h3 {
      color: #1a2332;
      font-size: 16px;
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .info-card ul {
      list-style: none;
      padding-left: 0;
    }
    
    .info-card li {
      padding: 6px 0;
      color: #555;
      font-size: 14px;
    }
    
    .info-card li::before {
      content: 'âœ“ ';
      color: #ffb800;
      font-weight: bold;
      margin-right: 8px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1a2332;
      font-size: 15px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #ffb800;
      box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #ffb800 0%, #ffa000 100%);
      color: #1a2332;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(255, 184, 0, 0.3);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 184, 0, 0.4);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* í€´ì¦ˆ í™”ë©´ */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffb800 0%, #ffa000 100%);
      transition: width 0.3s;
    }
    
    .question-box {
      background: #f8f9fa;
      border-left: 5px solid #1a2332;
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 12px;
    }
    
    .question-number {
      color: #ffb800;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 12px;
      display: inline-block;
      background: #1a2332;
      padding: 6px 16px;
      border-radius: 20px;
    }
    
    .question-text {
      font-size: 17px;
      line-height: 1.7;
      margin-bottom: 20px;
      color: #1a2332;
      font-weight: 500;
    }
    
    .choices {
      margin-top: 15px;
    }
    
    .choice-item {
      background: white;
      padding: 15px 20px;
      margin-bottom: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
    }
    
    .choice-item:hover {
      border-color: #ffb800;
      background: #fffbf0;
      transform: translateX(5px);
    }
    
    .choice-item.selected {
      border-color: #ffb800;
      background: #fffbf0;
    }
    
    .choice-item input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 15px;
      cursor: pointer;
      accent-color: #ffb800;
    }
    
    .choice-item label {
      flex: 1;
      cursor: pointer;
      font-size: 15px;
      color: #333;
    }
    
    .text-answer {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      min-height: 120px;
      resize: vertical;
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      transition: all 0.3s;
    }
    
    .text-answer:focus {
      outline: none;
      border-color: #ffb800;
      box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
    }
    
    /* ê²°ê³¼ í™”ë©´ */
    .result-box {
      text-align: center;
      padding: 40px 20px;
    }
    
    .score-circle {
      width: 200px;
      height: 200px;
      margin: 30px auto;
      border-radius: 50%;
      background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 10px 30px rgba(26, 35, 50, 0.3);
      border: 8px solid #ffb800;
    }
    
    .score-circle .score {
      font-size: 48px;
      font-weight: bold;
      color: #ffb800;
    }
    
    .score-circle .label {
      font-size: 16px;
      margin-top: 8px;
      opacity: 0.9;
    }
    
    .result-details {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-top: 30px;
      text-align: left;
      border: 2px solid #1a2332;
    }
    
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
      font-size: 15px;
    }
    
    .result-row:last-child {
      border-bottom: none;
    }
    
    .result-row strong {
      color: #1a2332;
    }
    
    /* ë¡œë”© í™”ë©´ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      display: none;
    }
    
    .loading.active {
      display: block;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ffb800;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #1a2332;
      margin-bottom: 10px;
    }
    
    .loading-subtext {
      color: #666;
      font-size: 14px;
    }
    
    /* ì—ëŸ¬ ë©”ì‹œì§€ */
    .error-message {
      background: #ffe5e5;
      color: #c33;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
      font-size: 15px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* í™”ë©´ ì „í™˜ */
    .screen {
      display: none;
    }
    
    .screen.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
      .container {
        border-radius: 0;
      }
      
      .content {
        padding: 20px;
      }
      
      .header {
        padding: 30px 20px;
      }
      
      .timer-box {
        position: static;
        margin-top: 20px;
        display: inline-block;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <div class="logo">ì¹´ì¹´ì˜¤ T</div>
      <h1>ê³ ê°ì„¼í„° ì§ë¬´í…ŒìŠ¤íŠ¸</h1>
      <div class="subtitle">AI ê¸°ë°˜ ì •ì±… í•™ìŠµ í‰ê°€ ì‹œìŠ¤í…œ</div>
      <div id="timerDisplay" class="timer-box">
        â° <span id="timer">05:00</span>
      </div>
    </div>
    
    <div class="content">
      <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
      <div id="loginScreen" class="screen active">
        <div class="info-card">
          <h3>ğŸ“‹ ì‹œí—˜ ì•ˆë‚´</h3>
          <ul>
            <li>ì´ 10ë¬¸ì œ (ê°ê´€ì‹ 8ë¬¸ì œ, ì£¼ê´€ì‹ 2ë¬¸ì œ)</li>
            <li>ì œí•œ ì‹œê°„: 5ë¶„</li>
            <li>ì¢…ë£Œ 1ë¶„ ì „ ì•Œë¦¼</li>
            <li>AIê°€ ì„ íƒí•œ ì„œë¹„ìŠ¤ ì •ì±…ì„ í•™ìŠµí•˜ì—¬ ë¬¸ì œ ìƒì„±</li>
            <li>ì‹œê°„ ì´ˆê³¼ ì‹œ ìë™ ì œì¶œ ë° ë¶€ë¶„ ì±„ì </li>
          </ul>
        </div>
        
        <h2 style="margin-bottom: 30px; color: #1a2332;">ì‘ì‹œì ì •ë³´ ì…ë ¥</h2>
        
        <div id="loginError" class="error-message"></div>
        
        <div class="form-group">
          <label>ID (ì˜ë¬¸ì´ë¦„) *</label>
          <input type="text" id="userId" placeholder="ì˜ˆ: honggildong" required>
        </div>
        
        <div class="form-group">
          <label>ì´ë¦„ *</label>
          <input type="text" id="userName" placeholder="í™ê¸¸ë™" required>
        </div>
        
        <div class="form-group">
          <label>ì„¼í„° *</label>
          <select id="center" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ìš©ì‚°">ìš©ì‚°</option>
            <option value="ê´‘ì£¼">ê´‘ì£¼</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì„œë¹„ìŠ¤ ì„ íƒ *</label>
          <select id="service" required>
            <option value="">ë¡œë”© ì¤‘...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì—­í•  *</label>
          <select id="role" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì‹ ì…ìƒë‹´ì‚¬">ì‹ ì…ìƒë‹´ì‚¬ (ì´ˆê¸‰)</option>
            <option value="ìƒë‹´ì‚¬">ìƒë‹´ì‚¬ (ì¤‘ê¸‰)</option>
            <option value="ê²½ë ¥ìƒë‹´ì‚¬">ê²½ë ¥ìƒë‹´ì‚¬ (ì¤‘ê¸‰)</option>
            <option value="ê´€ë¦¬ì">ê´€ë¦¬ì (ê³ ê¸‰)</option>
            <option value="íŒ€ì¥">íŒ€ì¥ (ê³ ê¸‰)</option>
          </select>
        </div>
        
        <button class="btn" onclick="startExam()">ì‹œí—˜ ì‹œì‘</button>
      </div>
      
      <!-- 2. ë¡œë”© í™”ë©´ -->
      <div id="loadingScreen" class="screen loading">
        <div class="spinner"></div>
        <div class="loading-text">ğŸ¤– AIê°€ ì •ì±…ì„ ë¶„ì„í•˜ê³  ë¬¸ì œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
        <div class="loading-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ì•½ 30ì´ˆ ì†Œìš”)</div>
      </div>
      
      <!-- 3. í€´ì¦ˆ í™”ë©´ -->
      <div id="quizScreen" class="screen">
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        
        <div id="questionsContainer"></div>
        
        <button class="btn" onclick="submitExam()">ì‹œí—˜ ì œì¶œ</button>
      </div>
      
      <!-- 4. ê²°ê³¼ í™”ë©´ -->
      <div id="resultScreen" class="screen">
        <div class="result-box">
          <h2 style="color: #1a2332; margin-bottom: 20px;">âœ… ì‹œí—˜ ì™„ë£Œ!</h2>
          
          <div class="score-circle">
            <div class="score"><span id="resultScore">0</span>/<span id="resultTotal">10</span></div>
            <div class="label">ì´ 10ë¬¸ì œ</div>
          </div>
          
          <h3 id="resultMessage" style="margin: 20px 0; color: #1a2332; font-size: 22px;">ğŸ’ª ë‹¤ìŒì— ë” ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</h3>
          
          <div class="result-details">
            <div class="result-row">
              <span><strong>ì‘ì‹œì</strong></span>
              <span id="resultName"></span>
            </div>
            <div class="result-row">
              <span><strong>ID</strong></span>
              <span id="resultId"></span>
            </div>
            <div class="result-row">
              <span><strong>ì„¼í„°</strong></span>
              <span id="resultCenter"></span>
            </div>
            <div class="result-row">
              <span><strong>ì„œë¹„ìŠ¤</strong></span>
              <span id="resultService"></span>
            </div>
            <div class="result-row">
              <span><strong>ì—­í• </strong></span>
              <span id="resultRole"></span>
            </div>
            <div class="result-row">
              <span><strong>ì •ë‹µ ìˆ˜</strong></span>
              <span><span id="resultCorrect">0</span>ê°œ</span>
            </div>
            <div class="result-row">
              <span><strong>ì •ë‹µë¥ </strong></span>
              <span><span id="resultPercentage">0</span>%</span>
            </div>
            <div class="result-row">
              <span><strong>ì†Œìš” ì‹œê°„</strong></span>
              <span id="resultTime"></span>
            </div>
          </div>
          
          <p style="margin-top: 30px; color: #666; font-size: 14px;">
            ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ìƒì„¸í•œ í•´ì„¤ì€ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // ì „ì—­ ë³€ìˆ˜
    // ==========================================
    let examInfo = null;
    let questions = [];
    let userAnswers = [];
    let startTime = null;
    let timerInterval = null;
    
    const TIME_LIMIT = 300; // 5ë¶„ (ì´ˆ ë‹¨ìœ„)
    const WARNING_TIME = 60; // 1ë¶„ ì „ ì•Œë¦¼
    
    // ==========================================
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    // ==========================================
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        const response = await fetch('/api/services');
        const data = await response.json();
        
        if (data.success && data.services) {
          const serviceSelect = document.getElementById('service');
          serviceSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
          
          data.services.forEach(service => {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service;
            serviceSelect.appendChild(option);
          });
        } else {
          throw new Error('ì„œë¹„ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        console.error('ì„œë¹„ìŠ¤ ë¡œë”© ì‹¤íŒ¨:', error);
        showError('ì„œë¹„ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    });
    
    // ==========================================
    // í™”ë©´ ì „í™˜ í•¨ìˆ˜
    // ==========================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
    }
    
    function hideError() {
      const errorDiv = document.getElementById('loginError');
      errorDiv.classList.remove('show');
    }
    
    // ==========================================
    // ì‹œí—˜ ì‹œì‘
    // ==========================================
    async function startExam() {
      const userId = document.getElementById('userId').value.trim();
      const userName = document.getElementById('userName').value.trim();
      const center = document.getElementById('center').value;
      const service = document.getElementById('service').value;
      const role = document.getElementById('role').value;
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!userId || !userName || !center || !service || !role) {
        showError('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      hideError();
      
      examInfo = { userId, userName, center, service, role };
      
      // ë¡œë”© í™”ë©´ í‘œì‹œ
      showScreen('loadingScreen');
      
      try {
        // ë°±ì—”ë“œì— í€´ì¦ˆ ìƒì„± ìš”ì²­
        const response = await fetch('/generate-quiz', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            service: service,
            role: role,
            numQuestions: 10
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          questions = data.questions;
          userAnswers = new Array(questions.length).fill(null);
          
          // í€´ì¦ˆ í™”ë©´ìœ¼ë¡œ ì „í™˜
          showScreen('quizScreen');
          displayQuestions();
          startTimer();
        } else {
          throw new Error(data.error || 'í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('âŒ í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        showScreen('loginScreen');
      }
    }
    
    // ==========================================
    // ë¬¸ì œ í‘œì‹œ
    // ==========================================
    function displayQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      
      questions.forEach((q, index) => {
        const qBox = document.createElement('div');
        qBox.className = 'question-box';
        
        const questionType = q.type || (index < 8 ? 'ê°ê´€ì‹' : 'ì£¼ê´€ì‹');
        
        let html = `
          <div class="question-number">ë¬¸ì œ ${index + 1} - ${questionType}</div>
          <div class="question-text">${q.question}</div>
        `;
        
        if (questionType === 'ê°ê´€ì‹') {
          html += '<div class="choices">';
          q.options.forEach((choice, i) => {
            html += `
              <div class="choice-item" onclick="selectChoice(${index}, ${i})">
                <input type="radio" name="q${index}" value="${i}" id="q${index}_${i}">
                <label for="q${index}_${i}">${choice}</label>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html += `
            <textarea class="text-answer" id="answer_${index}" 
              placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" 
              oninput="updateProgress()"></textarea>
          `;
        }
        
        qBox.innerHTML = html;
        container.appendChild(qBox);
      });
      
      updateProgress();
    }
    
    function selectChoice(questionIndex, choiceIndex) {
      userAnswers[questionIndex] = choiceIndex;
      
      // ì„ íƒëœ í•­ëª© ì‹œê°ì  í‘œì‹œ
      const choices = document.querySelectorAll(`[name="q${questionIndex}"]`);
      choices.forEach((radio, i) => {
        radio.parentElement.classList.toggle('selected', i === choiceIndex);
      });
      
      document.getElementById(`q${questionIndex}_${choiceIndex}`).checked = true;
      updateProgress();
    }
    
    function updateProgress() {
      let answered = 0;
      
      questions.forEach((q, i) => {
        const questionType = q.type || (i < 8 ? 'ê°ê´€ì‹' : 'ì£¼ê´€ì‹');
        
        if (questionType === 'ê°ê´€ì‹') {
          if (userAnswers[i] !== null) answered++;
        } else {
          const textarea = document.getElementById(`answer_${i}`);
          if (textarea && textarea.value.trim()) {
            userAnswers[i] = textarea.value.trim();
            answered++;
          }
        }
      });
      
      const percentage = (answered / questions.length) * 100;
      document.getElementById('progressFill').style.width = percentage + '%';
    }
    
    // ==========================================
    // íƒ€ì´ë¨¸
    // ==========================================
    function startTimer() {
      startTime = new Date();
      document.getElementById('timerDisplay').classList.add('active');
      
      let secondsLeft = TIME_LIMIT;
      let warningShown = false;
      
      function updateTimerDisplay() {
        const mins = Math.floor(secondsLeft / 60);
        const secs = secondsLeft % 60;
        const display = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        document.getElementById('timer').textContent = display;
        
        // 1ë¶„ ì „ ì•Œë¦¼
        if (secondsLeft === WARNING_TIME && !warningShown) {
          document.getElementById('timerDisplay').classList.add('warning');
          alert('âš ï¸ ì‹œí—˜ ì¢…ë£Œ 1ë¶„ ì „ì…ë‹ˆë‹¤!');
          warningShown = true;
        }
        
        // ì‹œê°„ ì´ˆê³¼
        if (secondsLeft <= 0) {
          clearInterval(timerInterval);
          alert('â° ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
          autoSubmitExam();
        }
        
        secondsLeft--;
      }
      
      updateTimerDisplay();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    
    // ==========================================
    // ì‹œí—˜ ì œì¶œ
    // ==========================================
    async function submitExam() {
      if (!confirm('ì •ë§ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì œì¶œ í›„ì—ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.')) {
        return;
      }
      
      await processSubmission();
    }
    
    async function autoSubmitExam() {
      await processSubmission(true);
    }
    
    async function processSubmission(isAutoSubmit = false) {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      // ë‹µì•ˆ ìˆ˜ì§‘
      updateProgress(); // ì£¼ê´€ì‹ ë‹µì•ˆ ìµœì¢… ìˆ˜ì§‘
      
      const endTime = new Date();
      const timeSpent = Math.round((endTime - startTime) / 1000); // ì´ˆ ë‹¨ìœ„
      
      // ì±„ì  ìš”ì²­
      try {
        const response = await fetch('/submit-exam', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: examInfo.userId,
            userName: examInfo.userName,
            center: examInfo.center,
            service: examInfo.service,
            role: examInfo.role,
            startTime: startTime.toISOString(),
            endTime: endTime.toISOString(),
            timeSpent: timeSpent,
            questions: questions,
            answers: userAnswers,
            isAutoSubmit: isAutoSubmit
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showResult(result, timeSpent);
        } else {
          throw new Error(result.error || 'ì œì¶œ ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('âŒ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ==========================================
    // ê²°ê³¼ í‘œì‹œ
    // ==========================================
    function showResult(result, timeSpent) {
      showScreen('resultScreen');
      document.getElementById('timerDisplay').classList.remove('active');
      
      const score = result.correctCount;
      const total = result.total;
      const percentage = result.percentage;
      
      document.getElementById('resultScore').textContent = score;
      document.getElementById('resultTotal').textContent = total;
      document.getElementById('resultPercentage').textContent = percentage;
      document.getElementById('resultName').textContent = examInfo.userName;
      document.getElementById('resultId').textContent = examInfo.userId;
      document.getElementById('resultCenter').textContent = examInfo.center;
      document.getElementById('resultService').textContent = examInfo.service;
      document.getElementById('resultRole').textContent = examInfo.role;
      document.getElementById('resultCorrect').textContent = score;
      
      // ì •ë‹µë¥ ì— ë”°ë¥¸ ë©”ì‹œì§€
      let message = '';
      if (percentage >= 90) {
        message = 'ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤! íƒì›”í•œ ì´í•´ë„ë¥¼ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤!';
      } else if (percentage >= 80) {
        message = 'ğŸŒŸ í›Œë¥­í•©ë‹ˆë‹¤! ë§¤ìš° ì˜ ì¤€ë¹„í•˜ì…¨ë„¤ìš”!';
      } else if (percentage >= 70) {
        message = 'ğŸ‘ ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! ì¶©ë¶„í•œ ì´í•´ë„ë¥¼ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤!';
      } else if (percentage >= 60) {
        message = 'ğŸ˜Š í•©ê²©ì…ë‹ˆë‹¤! ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ì™„ë²½í•´ì§ˆ ê±°ì˜ˆìš”!';
      } else if (percentage >= 50) {
        message = 'ğŸ’ª ì•„ì‰½ìŠµë‹ˆë‹¤! ì¡°ê¸ˆë§Œ ë” í•™ìŠµí•˜ë©´ ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê±°ì˜ˆìš”!';
      } else if (percentage >= 40) {
        message = 'ğŸ“š ë” ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤. ì •ì±…ì„ ë‹¤ì‹œ í•œ ë²ˆ ë³µìŠµí•´ë³´ì„¸ìš”!';
      } else {
        message = 'ğŸ”¥ í˜ë‚´ì„¸ìš”! ì •ì±… í•™ìŠµ í›„ ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!';
      }
      
      document.getElementById('resultMessage').textContent = message;
      
      const mins = Math.floor(timeSpent / 60);
      const secs = timeSpent % 60;
      document.getElementById('resultTime').textContent = 
        `${mins}ë¶„ ${secs}ì´ˆ`;
    }
    
    // ==========================================
    // í˜ì´ì§€ ì´íƒˆ ë°©ì§€
    // ==========================================
    window.addEventListener('beforeunload', function(e) {
      if (startTime && !document.getElementById('resultScreen').classList.contains('active')) {
        e.preventDefault();
        e.returnValue = 'ì‹œí—˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
      }
    });
  </script>
</body>
</html>
